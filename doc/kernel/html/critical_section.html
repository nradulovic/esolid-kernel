<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>eSolid - Real-Time Kernel: Critical sections</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="eSolid-logo_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">eSolid - Real-Time Kernel
   &#160;<span id="projectnumber">1.0BetaR01</span>
   </div>
   <div id="projectbrief">Event Based System</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="/"><span>Home&#160;page</span></a></li>
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Critical sections </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#cs_intro">Intro</a><ul><li class="level2"><a href="#kern_critical_sections">eSolid RT Kernel internal critical sections</a></li>
</ul>
</li>
<li class="level1"><a href="#cs_implementation">Implementation</a><ul><li class="level2"><a href="#cs_interrupt_lock">Disabling interrupts</a></li>
<li class="level2"><a href="#cs_kernel_lock">Disabling Kernel scheduler</a></li>
<li class="level2"><a href="#cs_sem_lock">Using semaphores</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>How to deal with critical sections in an application</p>
<p><br/>
<br/>
<br/>
</p>
<h1><a class="anchor" id="cs_intro"></a>
Intro</h1>
<p>In concurrent programming, a critical section is a piece of code that accesses a shared resource (data structure or device) that must not be concurrently accessed by more than one thread of execution. A critical section will usually terminate in fixed time, and a thread will have to wait for a fixed time to enter it (aka bounded waiting). Some synchronization mechanism is required at the entry and exit of the critical section to ensure exclusive use, for example a semaphore.</p>
<h2><a class="anchor" id="kern_critical_sections"></a>
eSolid RT Kernel internal critical sections</h2>
<p>In contrast to application code in kernel code there is no other mechanism to protect critical code except disabling interrupts. Fortunately, some ports have ability to mask certain interrupts with low priority and allow interrupts with higher priority. By masking low priority interrupts the kernel can protect its critical sections. However for this scheme to work its forbidden to call any OS service function from a high priority interrupt. If this rule is not followed then the high priority interrupt with an OS service function call can preempt the kernel low priority interrupt which will in that case corrupt the kernel internal data structures.</p>
<dl class="section note"><dt>Note</dt><dd>1) It is forbidden to call any OS service function from an interrupt with the priority higher than the kernel interrupt priority. </dd>
<dd>
2) On some ports the kernel never completely disables interrupts.</dd></dl>
<h1><a class="anchor" id="cs_implementation"></a>
Implementation</h1>
<p>There are multiple ways how are critical sections implemented:</p>
<ul>
<li>The simplest method is to prevent interrupts on entry into the critical section, and restoring interrupts to their previous state on exit from critical section. Any thread of execution entering any critical section anywhere in the system, with this implementation, will prevent any other thread, including an interrupt, from being executed on the CPU.</li>
<li>This approach can be improved upon by using semaphores. To enter a critical section, a thread must obtain a semaphore, which it releases on leaving the section. Other threads are prevented from entering the critical section at the same time as the original thread, but are free to gain control of the CPU and execute other code, including other critical sections that are protected by different semaphores.</li>
</ul>
<h2><a class="anchor" id="cs_interrupt_lock"></a>
Disabling interrupts</h2>
<p>In order to properly disable interrupts the application must follow these steps:</p>
<ul>
<li>declare an <code>auto</code> variable which will hold interrupt state</li>
<li>save interrupt status into <code>auto</code> variable and disable interrupts</li>
<li>access the shared resource</li>
<li>restore previously saved interrupt state</li>
</ul>
<p>For <code>auto</code> variable declaration macro ES_CRITICAL_DECL() is used. This macro will declare a temporary interrupt status variable. Then by using the macro <a class="el" href="group__kern__intf.html#ga90ec47263e8a05b91fe9359c97eb1c9c">ES_CRITICAL_ENTER()</a> the state of enabled interrupts will be saved in <code>auto</code> variable declared earlier. Immediately after saving the interrupt state the macro will lock interrupts. Now the code can safely access and use the shared resource. When code finishes using the resource it will call <a class="el" href="group__kern__intf.html#gade4fcc55ee1325723ed798a8c5e11e56">ES_CRITICAL_EXIT()</a> macro. This macro will restore interrupts from the previously saved interrupt state.</p>
<div class="fragment"><div class="line">ES_CRITICAL_DECL();                 <span class="comment">/* Declare an interrupt status variable */</span></div>
<div class="line">    :</div>
<div class="line">    :</div>
<div class="line">    :   </div>
<div class="line"><a class="code" href="group__kern__intf.html#ga90ec47263e8a05b91fe9359c97eb1c9c">ES_CRITICAL_ENTER</a>();                <span class="comment">/* Save state and lock interrupts */</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Access the shared resource</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code" href="group__kern__intf.html#gade4fcc55ee1325723ed798a8c5e11e56">ES_CRITICAL_EXIT</a>();                 <span class="comment">/* Restore previous state unlocking the interrupts */</span></div>
</div><!-- fragment --> <dl class="section user"><dt>When to use this scheme</dt><dd><ul>
<li>If interrupt service routine <em>changes</em> the shared resource state.</li>
<li>If the processing time of critical section is very small.</li>
</ul>
</dd></dl>
<dl class="section user"><dt>When not to use this scheme</dt><dd><ul>
<li>If interrupt service routine takes a lot of CPU time to process critical section. If a critical section is long, then the system clock will drift every time a critical section is executed because the system timer interrupt is no longer serviced, so tracking time is impossible during the critical section. Also, if a program execution halts during its critical section, control will never be returned to another thread, effectively halting the entire system.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="cs_kernel_lock"></a>
Disabling Kernel scheduler</h2>
<p>Another way to implement a critical section and protect your data is by locking the kernel scheduler. The kernel locking can be used only if you know that protected data will be modified only by other threads. This protection scheme can not be used when data is modified by interrupt service routines.</p>
<div class="fragment"><div class="line">esKernLockEnter();                  <span class="comment">/* Temporarily disable kernel scheduler  */</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Access the shared resource</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line">esKernLockExit();                   <span class="comment">/* Enable kernel scheduler */</span></div>
</div><!-- fragment --> <dl class="section user"><dt>When to use this scheme</dt><dd><ul>
<li>If interrupt service routine <em>never changes</em> the shared resource state.</li>
<li>If the processing time of critical section is very small.</li>
</ul>
</dd></dl>
<dl class="section user"><dt>When not to use this scheme</dt><dd><ul>
<li>If interrupt service routine takes a lot of CPU time to process critical section. If a critical section is long, then the system will be partially responsive to other events since interrupt service routines can be invoked, but note that any further processing by other threads is still disabled.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="cs_sem_lock"></a>
Using semaphores</h2>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
